<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üè° Proyecto Escolar STEM: Dise√±o de Casa Inteligente</title>
<style>
/* Estilos CSS Base para la Estructura Limpia */
:root{
  --accent:#ffb703; --muted:#9fbcd9; --good:#00ffb3; --danger:#ff4500;
  --panel-bg: rgba(0,0,0,0.65); 
  --project-color: #00e0ff; 
  --design-bg: #092c42; /* Fondo para el tablero de ideas */
}
*{box-sizing:border-box}
body{
    margin:0;
    font-family:Inter, "Segoe UI", Arial, sans-serif;
    background:linear-gradient(180deg,#04060a,#081822);
    color:#e6f7ff;
    overflow:hidden;
}
header{
    padding:12px;
    text-align:center;
    background:linear-gradient(180deg,#061526,#072733);
    border-bottom:2px solid rgba(255,183,3,0.06);
}
h1{margin:0;color:var(--project-color)}

/* --- ESTRUCTURA PRINCIPAL: Dashboard de Dise√±o --- */
main{
  display:grid;
  /* Tablero de Ideas (45%) | Herramientas (55%) */
  grid-template-columns: 1fr 1.3fr; 
  gap:16px;
  height:calc(100vh - 60px); 
  padding:16px;
}

/* Columna Izquierda: Listas de Tareas */
#ideas-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
    height: 100%;
    overflow-y: auto; /* CORRECCI√ìN: Permitir scroll */
    padding-right: 4px; 
}
/* Columna Derecha: Documentaci√≥n/M√©tricas */
#tools-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
    height: 100%; 
    overflow-y: auto; 
    padding-bottom: 20px; 
}


/* Estilos de Paneles */
.panel{background:var(--panel-bg);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);overflow:visible;}
.panel h2 { color: var(--project-color); border-bottom: 1px solid rgba(0,224,255,0.2); padding-bottom: 6px; margin-top: 0; }
.panel h3 { color: var(--accent); margin-top: 10px; margin-bottom: 6px;}

.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
button{background:var(--accent);color:#001;border:0;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700; transition: background 0.2s;min-width: 120px;}
button:hover { background: #ffc94e; }
button.secondary{background:transparent;color:#e6f7ff;border:1px solid rgba(255,255,255,0.06);flex-grow:1;}

/* --- NUEVO: Panel de Navegaci√≥n --- */
.nav-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
}
.nav-buttons button {
    background: rgba(0, 224, 255, 0.1);
    color: var(--project-color);
    border: 1px solid rgba(0, 224, 255, 0.5);
    text-align: left;
    padding: 12px;
    font-weight: 700;
    font-size: 1rem;
    transition: background 0.2s, color 0.2s;
    width: 100%;
}
.nav-buttons button:hover {
    background: var(--project-color);
    color: #04060a;
}


/* --- TABLERO DE FLUJO DE TRABAJO (Dise√±o) --- */
#design-workflow-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* Ideas, En Proceso, Finalizado */
    gap: 12px;
    flex-grow: 1;
    overflow-y: auto;
}
.design-lane {
    background: var(--design-bg);
    border-radius: 8px;
    padding: 10px;
    min-height: 150px;
    border-top: 3px solid var(--accent);
}
.design-lane h3 { 
    color: var(--accent); 
    font-size: 1.1rem; 
    margin: 0 0 10px 0;
    text-align: center;
}
.idea-card {
    background: rgba(255,255,255,0.08);
    padding: 8px;
    border-radius: 4px;
    margin-bottom: 6px;
    cursor: grab;
    border-left: 3px solid var(--project-color);
}
.idea-card.finalizado {
    border-left: 3px solid var(--good);
    opacity: 0.7;
    text-decoration: line-through;
}

/* --- ESTILOS ESPEC√çFICOS DEL PROYECTO --- */
.metric-row { display: flex; justify-content: space-between; margin-top: 4px; font-size: 0.95rem; }
.metric-value { font-weight: bold; color: var(--project-color); }

#design-output-area, #analisis-area {width:100%;min-height:150px;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.5);color:#e6f7ff}

/* Media Query para pantallas peque√±as */
@media (max-width:1200px){
    main{
        grid-template-columns: 1fr;
        height: auto;
        padding: 12px;
    } 
    #ideas-column { order: 1; height: 50vh; padding-right: 0;}
    #tools-column { order: 2; height: auto; }
    #design-workflow-container { grid-template-columns: 1fr; } 
}

/* Estilos del Mentor */
#mentor-button {
    position: fixed; bottom: 20px; right: 20px; z-index: 10000;
    width: 60px; height: 60px; border-radius: 50%; padding: 0;
    font-size: 28px; line-height: 60px; text-align: center;
    background: var(--accent);
    color: #001;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    border: 3px solid var(--project-color);
    cursor: pointer;
}
#mentor-chat-window {
    position: fixed; bottom: 90px; right: 20px; z-index: 9999;
    width: 320px; height: 400px; 
    background: #061526; 
    border: 2px solid var(--project-color); 
    border-radius: 12px;
    display: none; 
    flex-direction: column; overflow: hidden;
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6);
}
#chat-header {
    background: var(--project-color); 
    color: #001; 
    padding: 10px;
    font-weight: 700;
    text-align: center;
}
#chat-messages {
    flex: 1; padding: 10px; overflow-y: auto; 
    background: #081822; 
    color: #e6f7ff;
}
.chat-message { margin-bottom: 8px; max-width: 85%; padding: 8px 10px; border-radius: 10px; }
.user-message { background: #072733; margin-left: auto; text-align: right; }
.gemini-message { background: #1f3355; margin-right: auto; }
#chat-input-area { display: flex; padding: 8px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
#chat-input { flex-grow: 1; margin-right: 8px; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.06); background: #0e2942; color: white; }
#chat-send-btn-ui { background: var(--project-color); color: #001; font-weight: 700; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
</style>
</head>
<body>
<header>
  <h1>üè° Proyecto Escolar STEM: Dise√±o de Casa Inteligente</h1>
  <div class="small">Plataforma de **Investigaci√≥n, Esquematizaci√≥n y Prototipado** para el proyecto de innovaci√≥n.</div>
</header>

<main>
    <div id="ideas-column">
        
        <div id="navigation-panel" class="panel">
            <h2>Navegaci√≥n del Proyecto</h2>
            <div class="nav-buttons">
                <button onclick="scrollToSection('project-ideas')">1. Investigaci√≥n (Ideas)</button>
                <button onclick="scrollToSection('design-log')">2. Esquematizaci√≥n</button>
                <button onclick="scrollToSection('prototyping-metrics')">3. Prototipado</button>
                <button onclick="scrollToSection('analysis')">4. An√°lisis Final</button>
            </div>
        </div>

        <div id="project-ideas" class="panel">
            <h2>1. Investigaci√≥n: Lista de Ideas (Requisitos)</h2>
            <div id="ideas-list">
                </div>
            <h3 style="margin-top:10px;">A√±adir Requisito o Idea</h3>
            <p class="small" style="color: var(--muted);">Redacta tus ideas de funcionalidad (Ej: La luz debe encenderse autom√°ticamente).</p>
            <textarea id="new-idea-input" placeholder="Ej: Quiero que el sistema de calefacci√≥n se apague si no hay personas en la sala para evitar gastos innecesarios."></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
                <button id="btnAddIdea">‚ûï A√±adir Idea</button>
                <button id="btnStartCycle" class="secondary">‚ñ∂Ô∏è Iniciar Ciclo de Dise√±o</button>
            </div>
        </div>

        <div class="panel" style="flex-grow: 1;">
            <h2 style="border: none; padding-bottom: 0; margin-bottom: 12px;">Flujo de Dise√±o (Tareas Actuales)</h2>
            <p class="small">Arrastra las ideas a **En Proceso** cuando empieces el dise√±o, y a **Finalizado** cuando lo valides.</p>
            <div id="design-workflow-container">
                <div id="todo-lane" class="design-lane">
                    <h3>Ideas Seleccionadas</h3>
                    </div>
                <div id="in-progress-lane" class="design-lane">
                    <h3>En Proceso (Dise√±ando)</h3>
                </div>
                <div id="done-lane" class="design-lane">
                    <h3>Finalizado (Validado)</h3>
                </div>
            </div>
        </div>

    </div>

    <div id="tools-column">
        
        <div id="design-log" class="panel">
            <h2>2. Esquematizaci√≥n (Dise√±o L√≥gico)</h2>
            <p class="small">Describe el **dise√±o electr√≥nico y la l√≥gica de funcionamiento** de las ideas que est√°n **"En Proceso"**.</p>
            <textarea id="design-output-area" placeholder="Documenta tu proceso: Diagrama de bloques, componentes (sensores, microcontrolador) elegidos y c√≥mo se conectan. Justifica tus decisiones de ingenier√≠a."></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
                <button id="btnSaveDesign">üíæ Guardar Esquema</button>
            </div>
        </div>

        <div id="prototyping-metrics" class="panel">
            <h2>3. Prototipado (Validaci√≥n de Eficiencia)</h2>
            <p class="small">Simula el **impacto** de tu prototipo en el consumo el√©ctrico de la casa. ¬°El objetivo de **Innovaci√≥n** es ahorrar un **m√≠nimo de 30%**!</p>
            
            <h3 style="color: var(--project-color); margin-top: 12px;">M√©tricas de Validaci√≥n</h3>
            <div class="metric-row">
                <span>Consumo Base (Sin Innovaci√≥n):</span> 
                <span id="metric-base-consumption" class="metric-value">550 kW/h</span>
            </div>
            <div class="metric-row">
                <span>Ahorro Energ√©tico Logrado:</span> 
                <span id="metric-saving" class="metric-value">0%</span>
            </div>
            <div class="metric-row">
                <span>Consumo Estimado (Con Prototipo):</span> 
                <span id="metric-final-consumption" class="metric-value">550 kW/h</span>
            </div>
            <div class="metric-row">
                <span>Recursos Necesarios (Hardware):</span> 
                <span id="metric-resources" class="metric-value">B√°sico</span>
            </div>
            
            <div style="display:flex;gap:8px;margin-top:10px">
                <button id="btnSimulateDesign">‚ö° Validar Prototipo</button>
            </div>
        </div>

        <div id="analysis" class="panel">
            <h2>An√°lisis Final (Lecciones Aprendidas)</h2>
            <p class="small">Reflexiona sobre el ciclo de dise√±o. **Preguntas clave:** ¬øFuncion√≥ el prototipo como esperaban? ¬øQu√© problemas de ingenier√≠a resolvieron? ¬øQu√© har√≠an diferente si inician un nuevo ciclo?</p>
            <textarea id="analisis-area" placeholder="Escribe tu reflexi√≥n y conclusiones finales aqu√≠..."></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
                <button id="btnSaveAnalysis">üíæ Guardar An√°lisis Final</button>
            </div>
        </div>
    </div>
</main>

<button id="mentor-button" onclick="toggleChat()">ü§ñ</button>
<div id="mentor-chat-window" style="display: none;">
    <div id="chat-header">Mentor STEM Cool</div>
    <div id="chat-messages"></div>
    <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="Pregunta a tu mentor..." onkeydown="if(event.key==='Enter') sendMessage(event)">
        <button id="chat-send-btn-ui" onclick="sendMessage()">Enviar</button>
    </div>
</div>

<script>
// --- FUNCI√ìN DE NAVEGACI√ìN A√ëADIDA ---
function scrollToSection(sectionId) {
    const element = document.getElementById(sectionId);
    if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Efecto visual de resaltado temporal
        element.style.transition = 'box-shadow 0.5s ease-in-out';
        element.style.boxShadow = '0 0 25px var(--project-color)';
        setTimeout(() => {
            element.style.boxShadow = 'none';
        }, 1500); // El brillo desaparece despu√©s de 1.5 segundos
    }
}

// --- C√ìDIGO JAVASCRIPT: L√≥gica de Flujo de Dise√±o y Simulaci√≥n ---

// --- VARIABLES GLOBALES ---
const BASE_CONSUMPTION = 550; // kWh/mes
let ideaIdCounter = 1;
let ideas = []; 
let currentSavingPercent = 0; 
let currentResources = 'B√°sico'; // Simplificamos "coste" a "recursos"
let simulated = false;

// Definici√≥n inicial de Ideas (Requisitos)
const initialIdeas = [
    { id: 'I-1', text: 'Apagado autom√°tico de luces por falta de movimiento para ahorrar energ√≠a.', status: 'backlog', effort: 3, saving: 10, resources: 'Sensores de movimiento' },
    { id: 'I-2', text: 'Controlar el aire acondicionado de forma remota.', status: 'backlog', effort: 5, saving: 0, resources: 'M√≥dulo WiFi' },
    { id: 'I-3', text: 'Apagar la calefacci√≥n si hay una ventana abierta para evitar desperdicio.', status: 'backlog', effort: 8, saving: 15, resources: 'Sensor de contacto' },
    { id: 'I-4', text: 'Sistema de riego autom√°tico basado en humedad del suelo.', status: 'backlog', effort: 5, saving: 5, resources: 'Sensores de humedad' },
    { id: 'I-5', text: 'Integraci√≥n con paneles solares para reducir el consumo de la red.', status: 'backlog', effort: 13, saving: 25, resources: 'Microcontrolador avanzado' }
];
ideas = initialIdeas;

// --- REFERENCIAS DOM ---
const dom = {
  ideasList: document.getElementById('ideas-list'),
  newIdeaInput: document.getElementById('new-idea-input'),
  btnAddIdea: document.getElementById('btnAddIdea'),
  btnStartCycle: document.getElementById('btnStartCycle'),
  todoLane: document.getElementById('todo-lane'),
  inProgressLane: document.getElementById('in-progress-lane'),
  doneLane: document.getElementById('done-lane'),
  
  designOutputArea: document.getElementById('design-output-area'),
  btnSaveDesign: document.getElementById('btnSaveDesign'),
  btnSimulateDesign: document.getElementById('btnSimulateDesign'),

  metricBaseConsumption: document.getElementById('metric-base-consumption'),
  metricSaving: document.getElementById('metric-saving'),
  metricFinalConsumption: document.getElementById('metric-final-consumption'),
  metricResources: document.getElementById('metric-resources'),

  analisisArea: document.getElementById('analisis-area'),
  btnSaveAnalysis: document.getElementById('btnSaveAnalysis'),
};

// --- CORE FUNCTIONS (FLUJO DE DISE√ëO) ---

function init(){
    bindEvents();
    renderBacklogs();
    updateHouseMetrics();
}

function createIdeaCard(idea){
    const card = document.createElement('div');
    card.className = 'idea-card ' + (idea.status === 'done' ? 'finalizado' : '');
    card.id = idea.id;
    
    // Solo se permite arrastrar si est√° en una columna del Ciclo (Ideas Seleccionadas, En Proceso)
    card.draggable = idea.status !== 'backlog'; 
    
    card.innerHTML = `<div>${idea.text}</div>
                      <div class="small" style="color:var(--muted); margin-top: 4px;">**Esforzo Estimado: ${idea.effort}** | Recursos: ${idea.resources}</div>`;
    
    // Configuraci√≥n de Drag and Drop
    if (idea.status !== 'backlog') {
        card.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', idea.id);
            card.style.opacity = '0.5';
        });
        card.addEventListener('dragend', () => {
            card.style.opacity = '1';
        });
    }
    return card;
}

function renderBacklogs(){
    dom.ideasList.innerHTML = '';
    dom.todoLane.innerHTML = '<h3>Ideas Seleccionadas</h3>';
    dom.inProgressLane.innerHTML = '<h3>En Proceso (Dise√±ando)</h3>';
    dom.doneLane.innerHTML = '<h3>Finalizado (Validado)</h3>';

    // RENDER LISTA GENERAL DE IDEAS (Ordenado por esfuerzo)
    const backlog = ideas.filter(s => s.status === 'backlog').sort((a, b) => b.effort - a.effort);
    backlog.forEach(idea => {
        const card = createIdeaCard(idea);
        card.innerHTML += `<button onclick="addToCycle('${idea.id}')" style="margin-top: 6px; font-size: 0.8rem; padding: 4px; min-width: auto; background: var(--design-bg); color: var(--project-color); border: 1px solid var(--project-color);">Seleccionar</button>`;
        dom.ideasList.appendChild(card);
    });
    
    // RENDER FLUJO DE DISE√ëO
    const cycleIdeas = ideas.filter(s => s.status !== 'backlog');
    cycleIdeas.forEach(idea => {
        const card = createIdeaCard(idea);
        if (idea.status === 'todo') dom.todoLane.appendChild(card);
        else if (idea.status === 'in-progress') dom.inProgressLane.appendChild(card);
        else if (idea.status === 'done') dom.doneLane.appendChild(card);
    });
}

function addIdea(){
    const text = dom.newIdeaInput.value.trim();
    if (text.length < 10) { 
        alert('La idea debe ser m√°s descriptiva.'); 
        return; 
    }
    // L√≥gica de asignaci√≥n de m√©tricas simuladas
    const newIdea = {
        id: 'I-' + (++ideaIdCounter),
        text: text,
        status: 'backlog',
        effort: Math.ceil(Math.random() * 13), 
        saving: Math.floor(Math.random() * 15),
        resources: ['B√°sico', 'Intermedio', 'Avanzado'][Math.floor(Math.random() * 3)]
    };
    ideas.push(newIdea);
    dom.newIdeaInput.value = '';
    renderBacklogs();
    console.log(`[LOG] ‚ûï Nueva idea '${newIdea.id}' a√±adida a la Lista de Ideas.`);
}

function addToCycle(id){
    const idea = ideas.find(s => s.id === id);
    if (idea && idea.status === 'backlog'){
        idea.status = 'todo';
        idea.draggable = true;
        renderBacklogs();
        console.log(`[LOG] ‚ñ∂Ô∏è Idea '${id}' movida al Ciclo de Dise√±o (Ideas Seleccionadas).`);
    }
}

function startCycle(){
    if (ideas.filter(s => s.status !== 'backlog').length === 0) {
        alert('Debes seleccionar al menos una idea de la lista general antes de iniciar el Ciclo de Dise√±o.');
        return;
    }
    alert('¬°Ciclo de Dise√±o Iniciado! Comienca el dise√±o l√≥gico en la columna de la derecha y arrastra las ideas a "En Proceso" y "Finalizado" seg√∫n avances.');
    console.log('[LOG] üöÄ Ciclo de Dise√±o iniciado.');
}

function handleDrop(e, status){
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    const idea = ideas.find(s => s.id === id);
    if (idea){
        idea.status = status;
        renderBacklogs();
        console.log(`[LOG] ‚û°Ô∏è Idea '${id}' movida a la columna '${status.toUpperCase()}'.`);
        if (status === 'done') {
            updateMetricsFromCycle();
        }
    }
}

// --- CORE FUNCTIONS (PROTOTIPADO) ---

function updateHouseMetrics(){
    dom.metricBaseConsumption.textContent = BASE_CONSUMPTION + ' kW/h';
    const finalConsumption = BASE_CONSUMPTION * (1 - currentSavingPercent/100);
    
    dom.metricSaving.textContent = currentSavingPercent.toFixed(1) + '%';
    dom.metricFinalConsumption.textContent = finalConsumption.toFixed(1) + ' kW/h';
    dom.metricResources.textContent = currentResources;

    // Colores basados en objetivos (ahorro >= 30%)
    if (simulated) {
        dom.metricSaving.style.color = currentSavingPercent >= 30 ? 'var(--good)' : 'var(--danger)';
        dom.metricFinalConsumption.style.color = currentSavingPercent >= 30 ? 'var(--good)' : 'var(--danger)';
    } else {
        dom.metricSaving.style.color = 'var(--project-color)';
        dom.metricFinalConsumption.style.color = 'var(--project-color)';
    }
}

function updateMetricsFromCycle(){
    // Calcula el impacto total de las ideas "Finalizado"
    const doneIdeas = ideas.filter(s => s.status === 'done');
    let totalSaving = doneIdeas.reduce((sum, s) => sum + s.saving, 0);
    
    // Determinar el nivel de recursos m√°s alto usado
    const resourceLevels = { 'B√°sico': 1, 'Intermedio': 2, 'Avanzado': 3 };
    let maxLevel = 1;
    doneIdeas.forEach(idea => {
        maxLevel = Math.max(maxLevel, resourceLevels[idea.resources] || 1);
    });
    currentResources = Object.keys(resourceLevels).find(key => resourceLevels[key] === maxLevel);
    
    currentSavingPercent = Math.min(70, totalSaving); // Ahorro m√°ximo realista
    simulated = true;
    updateHouseMetrics();
    console.log(`[LOG] ‚úÖ Validaci√≥n: Se han simulado ${doneIdeas.length} ideas finalizadas.`);
}


function simulateDesign(){
    const doneCount = ideas.filter(s => s.status === 'done').length;
    if (doneCount === 0){
        alert('Debes mover a la columna "Finalizado" al menos una idea de dise√±o antes de realizar la Validaci√≥n del Prototipo.');
        return;
    }
    
    if (dom.designOutputArea.value.trim().length < 50){
        alert('¬°Importante! Documenta tu dise√±o en la fase de "Esquematizaci√≥n" para el informe final.');
    }
    
    updateMetricsFromCycle();
    
    const goalMet = currentSavingPercent >= 30;
    const msg = goalMet 
        ? '¬°Objetivo de Ahorro logrado! El prototipo es eficiente y la innovaci√≥n funciona.' 
        : 'A√∫n no alcanzas el 30% de ahorro. Vuelve al inicio del flujo y selecciona m√°s ideas enfocadas en la eficiencia para un nuevo Ciclo de Dise√±o.';
        
    alert(`Validaci√≥n de Prototipo completada. ${msg}`);
}

// --- UTILITIES (Guardar archivos) ---

function saveContent(elementId, name, logMsg){
    const text = document.getElementById(elementId).value.trim();
    if (!text) return alert(`Escribe el contenido de ${name} antes de guardar.`);
    
    const fileName = `${name.toLowerCase().replace(/ /g,'_')}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = fileName; a.click(); URL.revokeObjectURL(url);
    
    console.log(`[LOG] ${logMsg}`);
    alert(`${name} guardada correctamente.`);
}

// --- EVENT BINDING ---
function bindEvents(){
  dom.btnAddIdea.onclick = addIdea;
  dom.btnStartCycle.onclick = startCycle;
  dom.btnSimulateDesign.onclick = simulateDesign;
  
  dom.btnSaveDesign.onclick = () => saveContent('design-output-area', 'Esquematizacion', 'üíæ Esquema de dise√±o guardado.');
  dom.btnSaveAnalysis.onclick = () => saveContent('analisis-area', 'Analisis_Final', 'üíæ An√°lisis Final guardado.');

  // Configuraci√≥n de Drag and Drop para el flujo de dise√±o
  const lanes = [dom.todoLane, dom.inProgressLane, dom.doneLane];
  lanes.forEach(lane => {
      lane.addEventListener('dragover', (e) => {
          e.preventDefault(); 
          e.currentTarget.style.backgroundColor = 'rgba(0, 224, 255, 0.1)';
      });
      lane.addEventListener('dragleave', (e) => {
          e.currentTarget.style.backgroundColor = 'var(--design-bg)';
      });
      lane.addEventListener('drop', (e) => {
          e.currentTarget.style.backgroundColor = 'var(--design-bg)';
          handleDrop(e, lane.id.replace('-lane', ''));
      });
  });
}

/* Exponer funciones globales (necesario para los botones generados din√°micamente) */
window.addToCycle = addToCycle;

/* Start */
init();

/* --- L√ìGICA DEL MENTOR (CONEXI√ìN API DIRECTA) --- */

const MENTOR_API_KEY = 'AIzaSyApRjQC2CD2uoRfjfLlXuNx-qitPWP3Kbs'; 
const MODEL_NAME = 'gemini-2.5-flash'; 

const SYSTEM_INSTRUCTION_HOUSE = `
Eres el "Mentor STEM Cool", un gu√≠a experto en el Ciclo de Dise√±o y eficiencia energ√©tica para el Proyecto Casa Inteligente. Tu funci√≥n es crucial: guiar al estudiante a reflexionar sobre la secuencia de ingenier√≠a, forz√°ndolo a justificar sus decisiones y evaluar sus m√©tricas de eficiencia.

REGLAS DE ANDAMIAJE:

1. ROL: Usa un tono profesional y motivador, enfocado en la ingenier√≠a y el ahorro.
2. FASE DE IDEAS (Kanban): Si el estudiante pregunta qu√© ideas seleccionar, preg√∫ntale por la **prioridad y la m√©trica**. Ejemplo: "¬øCu√°l de tus ideas ofrece el mayor **ahorro energ√©tico**? ¬øDeber√≠as priorizar el impacto o el menor esfuerzo (recursos)?"
3. FASE DE DISE√ëO (Esquematizaci√≥n): Si el estudiante pregunta sobre la l√≥gica, preg√∫ntale por la **conexi√≥n causal y los componentes**. Ejemplo: "El sensor de movimiento detecta, pero ¬øqu√© l√≥gica (IF/THEN) le dir√° al actuador que apague la luz? ¬øC√≥mo se comunica el microcontrolador con el sensor?"
4. VALIDACI√ìN (Prototipado): Si el estudiante pregunta si el ahorro de 15% es bueno, preg√∫ntale por el **objetivo de innovaci√≥n**. Ejemplo: "**¬øTu ahorro de 15% cumple con el objetivo de innovaci√≥n (30%)?** ¬øQu√© tendr√≠as que hacer en el pr√≥ximo ciclo de dise√±o para duplicar el ahorro?"
5. AN√ÅLISIS FINAL: Preg√∫ntale por las **lecciones del proceso**. Ejemplo: "¬øCu√°l fue la mayor dificultad de ingenier√≠a que resolviste, y c√≥mo ese aprendizaje cambiar√° tu pr√≥ximo dise√±o?"
6. PROHIBICI√ìN: Nunca des el c√°lculo final o la respuesta directa.

`;

function toggleChat() {
    const chatWindow = document.getElementById('mentor-chat-window');
    // Alterna la visibilidad
    chatWindow.style.display = chatWindow.style.display === 'none' ? 'flex' : 'none';

    if (chatWindow.style.display === 'flex') {
        document.getElementById('chat-input').focus();
        
        const messagesDiv = document.getElementById('chat-messages');
        messagesDiv.innerHTML = ''; 
        
        appendMessage('gemini', 'üëã ¬°Hola, ingeniero! Soy tu **Mentor STEM Cool**. Mi trabajo es guiar la eficiencia de tu dise√±o. ¬øEn qu√© fase (Ideas, Dise√±o o An√°lisis) necesitas ayuda?');
    }
}

async function sendMessage(event) {
    const input = document.getElementById('chat-input');
    
    // Bloquear la acci√≥n por defecto si es Enter
    if (event && event.key === 'Enter') event.preventDefault(); 
    
    const message = input.value.trim();

    if (!message) return;

    if (event && event.type === 'keydown' && event.key !== 'Enter') return; 

    appendMessage('user', message);
    input.value = '';
    
    input.disabled = true;
    appendMessage('gemini', '‚öôÔ∏è Analizando ciclo de dise√±o...'); 
    const loadingMessage = document.querySelector('.gemini-message:last-child');

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${MENTOR_API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [
                    { role: "user", parts: [{ text: SYSTEM_INSTRUCTION_HOUSE + "\n\nConsulta del jugador: " + message }] } 
                ],
                generationConfig: {
                    temperature: 0.7 
                }
            })
        });

        const data = await response.json();
        
        let responseText = '‚ùå Error de API: No se pudo obtener una respuesta.';
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
             responseText = data.candidates[0].content.parts[0].text;
        } else if (data.error) {
            responseText = `‚ùå Error de API: ${data.error.message}. (Verifica si el uso est√° habilitado o si hay bloqueo de CORS).`;
        }

        loadingMessage.remove(); 
        appendMessage('gemini', responseText);

    } catch (error) {
        console.error('Error al enviar mensaje a Gemini:', error);
        loadingMessage.remove(); 
        appendMessage('gemini', '‚ö†Ô∏è Error de conexi√≥n. Revisa la Consola (F12) para detalles.');
    } finally {
        input.disabled = false;
        document.getElementById('chat-input').focus();
    }
}

function appendMessage(sender, text) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}-message`;

    const formattedText = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');

    messageDiv.innerHTML = formattedText;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll
}
</script>
</body>
</html>