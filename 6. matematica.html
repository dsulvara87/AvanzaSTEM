<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Jumanji Did√°ctico: 30 Retos y Registro de KP</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=IM+Fell+English+SC&display=swap" rel="stylesheet">

<style>
/* 1. Variables y Paleta de Colores (Jungla y Madera Antigua) */
:root {
    --bg-dark: #1e3a2e; /* Verde Oscuro Profundo (Jungla) */
    --bg-light: #4a6c4b; /* Verde Olivo (Fondo Secundario) */
    --wood-dark: #5c4033; /* Marr√≥n Oscuro (Madera) */
    --parchment: #f0e6c7; /* Pergamino Antiguo */
    --text-dark: #333333; /* Tinta sobre pergamino */
    --muted: #795d4f; /* Texto secundario en el pergamino */
    --accent-gold: #d4af37; /* Oro Antiguo */
    --success: #38a169; /* √âxito (Verde Brillo) */
    --danger: #9a3412; /* Peligro (Rojo Ladrillo) */
}
* {
    box-sizing: border-box;
}
body {
    font-family: 'Cinzel', serif;
    margin: 0;
    background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-light) 100%);
    color: var(--parchment);
    min-height: 100vh;
    padding: 20px;
}

/* 2. Estilo de Encabezado y T√≠tulo */
header {
    text-align: center;
    margin-bottom: 30px;
}
header h1 {
    font-family: 'IM Fell English SC', serif;
    font-size: 3.5rem;
    color: var(--accent-gold);
    text-shadow: 0 0 10px rgba(212, 175, 55, 0.7);
    border-bottom: 4px double var(--accent-gold);
    padding-bottom: 10px;
    margin: 0 auto;
    max-width: 900px;
}

/* 3. Contenedores Principales (El Tablero de Madera) */
.container {
    max-width: 1200px; 
    margin: 0 auto;
    background: var(--wood-dark);
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.8), inset 0 0 15px rgba(0, 0, 0, 0.5);
    border: 5px solid var(--accent-gold);
}
.grid {
    display: grid;
    grid-template-columns: 2fr 1fr; 
    gap: 30px;
}
@media (max-width: 980px) {
    .grid {
        grid-template-columns: 1fr;
    }
    .right-panel {
        order: -1; 
    }
}

/* 4. Estilo de Fichas (Avatares y Hojas de Personaje) */
.card {
    background: var(--parchment);
    color: var(--text-dark);
    padding: 20px;
    border-radius: 4px;
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.4);
    margin-bottom: 20px;
    border: 2px solid var(--wood-dark);
}
.char-stat {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px dashed var(--wood-dark);
    font-weight: 700;
}
.stat-value {
    color: var(--danger);
}
#avatar-select {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    font-family: 'Cinzel', serif;
}
.avatar-desc {
    font-size: 0.9rem;
    color: var(--muted);
    font-style: italic;
    margin-top: 5px;
}

/* 5. Botones y Controles */
.btn {
    width: 100%;
    padding: 15px 20px;
    border: none;
    cursor: pointer;
    font-family: 'Cinzel', serif;
    font-weight: 700;
    font-size: 1.2rem;
    text-transform: uppercase;
    background: var(--danger); 
    color: white;
    box-shadow: 0 4px 0 var(--wood-dark);
    transition: all 0.1s;
}
.btn:active {
    transform: translateY(4px);
    box-shadow: none;
}

/* 6. √Årea de Desaf√≠o y Resultado (La Carta de la Jungla) */
#card-display {
    min-height: 150px;
    text-align: left; 
    margin-top: 20px;
    padding: 20px;
    background: var(--bg-light);
    color: var(--parchment);
    border: 3px double var(--accent-gold);
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.7);
    border-radius: 4px;
}
#card-display h3 {
    color: var(--accent-gold);
    margin-top: 0;
    font-size: 1.5rem;
    text-align: center;
}
#problem-statement {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--parchment);
    padding: 10px;
    background: rgba(0,0,0,0.2);
    border-radius: 2px;
}
#student-solution {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    font-family: 'Cinzel', serif;
    color: var(--text-dark);
}
.result.success {
    background: var(--success);
    color: var(--wood-dark);
}
.result.failure {
    background: var(--danger);
    color: white;
}
#stat-kp {
    font-size: 1.1rem;
    color: var(--accent-gold) !important;
}

/* Estilos para el nuevo cuadro de registro de KP */
#score-summary h3 {
    color: var(--accent-gold);
    font-size: 1.3rem;
}
#kp-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-family: 'Inter', sans-serif;
}
#kp-table th, #kp-table td {
    border: 1px solid var(--wood-dark);
    padding: 10px;
    text-align: center;
}
#kp-table th {
    background-color: var(--wood-dark);
    color: var(--parchment);
}
#kp-table td {
    background-color: #ffe;
    color: var(--text-dark);
    font-weight: 700;
}

/* 7. Estilo del Mentor (Caja de Pergamino y Tinta) */
#mentor-button {
    position: fixed; bottom: 20px; right: 20px; z-index: 10000;
    width: 60px; height: 60px; border-radius: 50%; padding: 0;
    font-size: 28px; line-height: 60px; text-align: center;
    background: var(--accent-gold); 
    color: var(--wood-dark);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
    border: 3px solid var(--parchment);
    cursor: pointer;
}
#mentor-chat-window {
    position: fixed; bottom: 90px; right: 20px; z-index: 9999;
    width: 320px; height: 400px; 
    background: var(--wood-dark); 
    border: 5px solid var(--accent-gold); 
    border-radius: 8px;
    display: flex; flex-direction: column; overflow: hidden;
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.8);
}
#chat-header {
    background: var(--parchment); 
    color: var(--text-dark); 
    padding: 10px;
    font-family: 'IM Fell English SC', serif;
    text-align: center;
    font-size: 1.2rem;
    border-bottom: 2px solid var(--wood-dark);
}
#chat-messages {
    flex: 1; padding: 10px; overflow-y: auto; 
    background: var(--parchment); 
    color: var(--text-dark);
    border-top: 1px solid var(--wood-dark);
    border-bottom: 1px solid var(--wood-dark);
}
.chat-message-mentor {
    background: #e9e0c1; /* Pergamino m√°s claro */
    color: var(--wood-dark); 
    padding: 8px 10px; border-radius: 6px; 
    margin-bottom: 8px; max-width: 85%;
    font-size: 0.9rem;
    font-family: Arial, sans-serif;
}
.chat-message-user {
    background: var(--wood-dark);
    color: white; 
    padding: 8px 10px; border-radius: 6px; 
    margin-bottom: 8px; max-width: 85%;
    margin-left: auto; text-align: right;
    font-size: 0.9rem;
    font-family: Arial, sans-serif;
}
#chat-input-area { 
    display: flex; padding: 8px; 
    background: var(--wood-dark);
}
#chat-input { 
    flex-grow: 1; margin-right: 8px; 
    padding: 8px; border-radius: 4px; 
    border: 1px solid var(--muted);
    font-family: 'Cinzel', serif;
    color: var(--text-dark);
}
#chat-send-btn {
    background: var(--accent-gold);
    color: var(--wood-dark);
    border: none; padding: 8px 12px; border-radius: 4px;
    font-weight: 700;
}
</style>
</head>
<body>
<header>
    <h1>JUMANJI DID√ÅCTICO: 30 RETOS Y REGISTRO DE KP</h1>
    <p style="font-size:1.2rem; margin-top:-10px; color:var(--accent-gold)">¬°Resuelve el c√≥digo matem√°tico o la jungla te consumir√°!</p>
</header>

<div class="container">
    <div id="char-selection">
        <div class="card">
            <h2>1. Elige tu Especialista de 9¬∞ Grado</h2>
            <select id="avatar-select">
                <option value="" disabled selected>-- Elige tu Especialista --</option>
                <option value="algebrist">El Algebrista (√Ålgebra)</option>
                <option value="geometer">La Ge√≥metra (Geometr√≠a)</option>
                <option value="statistician">El Estad√≠stico (Estad√≠stica)</option>
            </select>
            <p id="avatar-desc" class="avatar-desc">Selecciona un avatar para ver sus fortalezas.</p>
            <button class="btn" id="confirm-avatar">Comenzar la Expedici√≥n</button>
        </div>
    </div>

    <div id="game-board" class="grid" style="display:none;">
        <div id="left-column">
            <div class="card" id="char-sheet">
                <h2 id="char-name">Hoja de Matem√°tico</h2>
                <div class="char-stat"><span>√Ålgebra (Alg)</span> <span id="stat-alg" class="stat-value">0</span></div>
                <div class="char-stat"><span>Geometr√≠a (Geo)</span> <span id="stat-geo" class="stat-value">0</span></div>
                <div class="char-stat"><span>Estad√≠stica (Est)</span> <span id="stat-est" class="stat-value">0</span></div>
                <div class="char-stat" style="border-top: 2px solid var(--wood-dark);">
                    <span>**PUNTOS DE CONOCIMIENTO TOTAL (KP)**</span> 
                    <span id="stat-kp" class="stat-value">0</span>
                </div>
                <div class="char-stat"><span>Puntos de Enfoque (Vidas)</span> <span id="stat-lives" class="stat-value" style="color: var(--success);">3</span></div>
            </div>

            <div class="card" id="score-summary">
                <h3>Registro de KP por Habilidad</h3>
                <table id="kp-table">
                    <thead>
                        <tr>
                            <th>√Ålgebra</th>
                            <th>Geometr√≠a</th>
                            <th>Estad√≠stica</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="kp-scores">
                            <td id="kp-alg">0</td>
                            <td id="kp-geo">0</td>
                            <td id="kp-est">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <div id="challenge-area">
                <h2>2. La Carta de Desaf√≠o de 9¬∞ Grado</h2>
                <div id="card-display">
                    <h3>Esperando el primer lanzamiento...</h3>
                    <p style="text-align:center;">Usa el bot√≥n "Lanzar los Dados" para que Jumanji revele el pr√≥ximo reto de 9¬∞ Grado.</p>
                </div>
            </div>
             <button class="btn" id="roll-dice">LANZAR LOS DADOS (VERIFICAR SOLUCI√ìN)</button>
             <p style="color:var(--accent-gold); text-align:center; font-size:0.9rem; margin-top:10px;">* La tirada valida tu dominio del tema. La exactitud de la respuesta es clave.</p>
        </div>
        
        <aside class="right-panel">
            <div class="card didactic-card">
                <h3>Gu√≠a del Gremio Did√°ctico (Unidad de 9¬∞)</h3>
                <hr style="border-top: 1px solid var(--muted);">
                <h4>Unidad: √Ålgebra, Geometr√≠a y Estad√≠stica (Grado 9)</h4>
                <p><strong>Objetivo Did√°ctico:</strong> Utilizar las herramientas matem√°ticas para resolver situaciones contextuales de Noveno Grado.</p>
                <h4>Temas a Desarrollar:</h4>
                <ul class="didactic-list">
                    <li>√Ålgebra: Ecuaciones, Sistemas, Factorizaci√≥n.</li>
                    <li>Geometr√≠a: Pit√°goras, √Årea, Volumen, √Ångulos.</li>
                    <li>Estad√≠stica: Probabilidad, Medidas de Tendencia Central.</li>
                </ul>
                <p style="font-size:0.85rem; color:var(--danger)">**Regla de la Jungla:** Acertar la respuesta **suma 1 KP**. Fallar solo te hace perder 1 Punto de Enfoque (Vida).</p>
            </div>
             <div class="card didactic-card" id="mentor-card" style="margin-top:20px;">
                <h3>El Or√°culo Matem√°tico</h3>
                <p style="font-size:0.9rem; color:var(--muted); font-family:Arial, sans-serif;">P√≠dele al Or√°culo que te gu√≠e en el proceso de soluci√≥n antes de arriesgar tu enfoque.</p>
                <div id="chat-widget">
                    <div id="chat-messages-container" style="max-height:200px; overflow-y:auto; border:1px solid var(--wood-dark); background:var(--parchment); padding:8px; border-radius:4px;">
                        <div class="chat-message-mentor" style="margin-bottom:0;">Soy el Or√°culo. Tu misi√≥n es la reflexi√≥n. Env√≠ame tu duda sobre el reto.</div>
                    </div>
                    <div style="display:flex; margin-top:10px;">
                        <input type="text" id="mentor-input" placeholder="Pregunta al Or√°culo..." style="flex-grow:1; margin-right:8px; padding:8px; font-family:Arial, sans-serif;">
                        <button id="mentor-send-btn" class="btn" style="width:auto; padding:8px 12px; font-size:1rem; box-shadow:none;">Consultar</button>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<button id="mentor-button" onclick="toggleChat()">ü§ñ</button>
<div id="mentor-chat-window" style="display:none;">
    <div id="chat-header">El Gu√≠a del Enigma</div>
    <div id="chat-messages"></div>
    <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="Pregunta a tu mentor..." onkeydown="if(event.key==='Enter') sendMessage()">
        <button id="chat-send-btn" class="btn" style="width:auto; font-size:1rem; padding:8px 12px;">Enviar</button>
    </div>
</div>

<script>
// Clave API (Placeholder, recuerda la restricci√≥n de CORS)
const MENTOR_API_KEY = 'AIzaSyBatnEUgvVX0UleWvoAxIocfIbLl73qyTk'; 

// **********************************************
// **** INSTRUCCI√ìN DEL MENTOR TEM√ÅTICO (Gu√≠a de Reflexi√≥n) ****
// **********************************************
const SYSTEM_INSTRUCTION_JUMANJI = `
Eres el "Gu√≠a del Enigma", el asistente matem√°tico de Jumanji. Tu funci√≥n es crucial: guiar al jugador para que reflexione sobre su **estrategia de resoluci√≥n de problemas** antes de que arriesgue un Punto de Enfoque (Vida).

REGLAS DE ANDAMIAJE (NO DAR LA RESPUESTA FINAL O F√ìRMULA):

1. ROL: Habla con un tono m√≠stico, serio y motivador, digno de la jungla ("Observa el Enigma", "La jungla requiere tu mejor an√°lisis").
2. √ÅLGEBRA (Alg): Si la pregunta es de √Ålgebra, pregunta por la **jerarqu√≠a de operaciones** o el **despeje de la variable**. Ejemplo: "¬øCu√°l es el primer paso para aislar la variable 'x'? ¬øIdentificaste el factor com√∫n o la diferencia de cuadrados?"
3. GEOMETR√çA (Geo): Si la pregunta es de Geometr√≠a, pregunta por el **teorema o propiedad geom√©trica** clave. Ejemplo: "¬øQu√© dice el Teorema de Pit√°goras sobre estos lados? ¬øCu√°nto deben sumar los √°ngulos internos de esa figura?"
4. ESTAD√çSTICA (Est): Si es de Estad√≠stica/Probabilidad, pregunta por la **organizaci√≥n de datos** o la **definici√≥n del evento**. Ejemplo: "Para la Mediana, ¬øordenaste el conjunto de datos? Para la Probabilidad, ¬øcu√°l es el n√∫mero total de eventos posibles (el denominador)?"
5. ENTRADA DEL JUGADOR: El jugador te preguntar√° directamente sobre el reto que est√° viendo en la carta.
`;


// Definici√≥n de Avatares
const AVATARS = {
    algebrist: { name: "El Algebrista", desc: "Experto en modelar y despejar ecuaciones complejas.", stats: { alg: 5, geo: 3, est: 4 } },
    geometer: { name: "La Ge√≥metra", desc: "Maestra de las formas y el espacio. Domina las propiedades de figuras.", stats: { alg: 4, geo: 5, est: 3 } },
    statistician: { name: "El Estad√≠stico", desc: "Domina el an√°lisis de datos, probabilidad y tendencias.", stats: { alg: 3, geo: 4, est: 5 } }
};

// 30 DESAF√çOS DE 9¬∞ GRADO (10 por habilidad)
const CHALLENGES = [
    // --- √ÅLGEBRA (10) ---
    { text: "Resuelva la ecuaci√≥n simple: 3x + 5 = 20. Escriba solo el valor entero de x.", skill: "alg", difficulty: 6, answer: ["5"], fail_message: "El despeje algebraico es incorrecto." },
    { text: "Resuelva la ecuaci√≥n: x¬≤ - 4 = 0. Escriba las dos soluciones separadas por 'o' (Ej: 2o-2).", skill: "alg", difficulty: 8, answer: ["2o-2", "-2o2"], fail_message: "Falla en el c√≥digo cuadr√°tico." },
    { text: "Factorice la diferencia de cuadrados: 4a¬≤ - 9. Escriba la respuesta sin espacios (Ej: (2a+3)(2a-3)).", skill: "alg", difficulty: 9, answer: ["(2a+3)(2a-3)", "(2a-3)(2a+3)"], fail_message: "La factorizaci√≥n no es v√°lida." },
    { text: "Simplifique la expresi√≥n: 2x + 3y - x + y. Escriba la respuesta sin espacios (Ej: x+4y).", skill: "alg", difficulty: 7, answer: ["x+4y"], fail_message: "Error al combinar t√©rminos semejantes." },
    { text: "Resuelva la inecuaci√≥n: 2x - 1 < 5. Escriba solo el valor m√°ximo entero de x.", skill: "alg", difficulty: 8, answer: ["2"], fail_message: "El l√≠mite de la inecuaci√≥n es incorrecto." },
    { text: "Cu√°l es la pendiente de la recta: y = 5x - 3? Escriba solo el n√∫mero entero.", skill: "alg", difficulty: 6, answer: ["5"], fail_message: "La pendiente no es detectada." },
    { text: "Si un n√∫mero m√°s su doble suman 18, ¬øcu√°l es el n√∫mero? Escriba solo el n√∫mero entero.", skill: "alg", difficulty: 7, answer: ["6"], fail_message: "El planteamiento del problema es fallido." },
    { text: "Resuelva la ecuaci√≥n: (x+1)¬≤ = 9. Escriba las dos soluciones separadas por 'o'.", skill: "alg", difficulty: 9, answer: ["2o-4", "-4o2"], fail_message: "Las ra√≠ces son err√≥neas." },
    { text: "Simplifique la potencia: (x¬≥) / x¬≤. Escriba la potencia resultante (Ej: x4).", skill: "alg", difficulty: 8, answer: ["x4"], fail_message: "Error en las leyes de exponentes." },
    { text: "Si x = 4, ¬øcu√°l es el valor de la expresi√≥n: 3x - 5? Escriba solo el n√∫mero entero.", skill: "alg", difficulty: 6, answer: ["7"], fail_message: "El valor num√©rico es incorrecto." },

    // --- GEOMETR√çA (10) ---
    { text: "Calcula el √°rea de un c√≠rculo con radio de 10. Use œÄ ‚âà 3.14. Escriba el valor num√©rico con dos decimales (Ej: 314.00).", skill: "geo", difficulty: 8, answer: ["314.00"], fail_message: "El c√°lculo del √°rea del c√≠rculo es incorrecto." },
    { text: "Calcula el per√≠metro de un cuadrado con lado de 6 cm. Escriba solo el n√∫mero entero.", skill: "geo", difficulty: 6, answer: ["24"], fail_message: "El per√≠metro es incorrecto." },
    { text: "Si un √°ngulo de un tri√°ngulo es 30¬∞ y otro es 70¬∞, ¬øcu√°nto mide el tercer √°ngulo? Escriba solo el n√∫mero entero.", skill: "geo", difficulty: 7, answer: ["80"], fail_message: "La suma de √°ngulos es incorrecta." },
    { text: "Calcula el volumen de un cubo cuyo lado mide 5 m. Escriba solo el n√∫mero entero.", skill: "geo", difficulty: 7, answer: ["125"], fail_message: "El volumen es incorrecto." },
    { text: "Los lados de un tri√°ngulo miden 5, 12 y 13. ¬øEs un tri√°ngulo rect√°ngulo? Escriba Si o No.", skill: "geo", difficulty: 8, answer: ["si"], fail_message: "Falla el teorema de Pit√°goras." },
    { text: "¬øCu√°ntos grados suman los √°ngulos interiores de un cuadril√°tero? Escriba solo el n√∫mero entero.", skill: "geo", difficulty: 6, answer: ["360"], fail_message: "Falla la suma de √°ngulos de pol√≠gonos." },
    { text: "Calcula la longitud de la diagonal de un rect√°ngulo de 3 cm por 4 cm. Escriba solo el n√∫mero entero.", skill: "geo", difficulty: 7, answer: ["5"], fail_message: "El c√°lculo de la diagonal es incorrecto." },
    { text: "El √°rea de un rect√°ngulo es 40 cm¬≤. Si el ancho es 5 cm, ¬øcu√°nto mide el largo? Escriba solo el n√∫mero entero.", skill: "geo", difficulty: 6, answer: ["8"], fail_message: "El √°rea y los lados no concuerdan." },
    { text: "Calcula el √°rea de un tri√°ngulo de base 10 cm y altura 7 cm. Escriba solo el n√∫mero entero.", skill: "geo", difficulty: 7, answer: ["35"], fail_message: "El √°rea del tri√°ngulo es incorrecta." },
    { text: "Si dos rectas paralelas son cortadas por una transversal, ¬øcu√°nto suman los √°ngulos consecutivos internos? Escriba solo el n√∫mero entero.", skill: "geo", difficulty: 8, answer: ["180"], fail_message: "Error en √°ngulos entre paralelas." },

    // --- ESTAD√çSTICA (10) ---
    { text: "¬øCu√°l es la Mediana del siguiente conjunto de datos: 5, 8, 1, 10, 4? Escriba solo el n√∫mero entero.", skill: "est", difficulty: 7, answer: ["5"], fail_message: "Falla en la Mediana." },
    { text: "¬øCu√°l es la Media (promedio) de 10, 20 y 30? Escriba solo el n√∫mero entero.", skill: "est", difficulty: 6, answer: ["20"], fail_message: "El promedio es incorrecto." },
    { text: "¬øCu√°l es el Rango del conjunto de datos: 1, 15, 8, 4? Escriba solo el n√∫mero entero.", skill: "est", difficulty: 7, answer: ["14"], fail_message: "El rango es incorrecto." },
    { text: "Si hay 3 camisetas rojas y 2 azules, ¬øcu√°l es la probabilidad (fracci√≥n) de sacar una azul? (Ej: 2/5).", skill: "est", difficulty: 7, answer: ["2/5"], fail_message: "El c√°lculo de probabilidad es incorrecto." },
    { text: "Al lanzar dos dados, ¬øcu√°l es la probabilidad de que la suma sea 12? (Fracci√≥n: 1/36).", skill: "est", difficulty: 9, answer: ["1/36"], fail_message: "La probabilidad compuesta es incorrecta." },
    { text: "¬øCu√°l es la Moda del conjunto: 2, 5, 5, 8, 2, 5? Escriba solo el n√∫mero entero.", skill: "est", difficulty: 6, answer: ["5"], fail_message: "La moda es incorrecta." },
    { text: "Si la probabilidad de lluvia es 0.6, ¬øcu√°l es la probabilidad de que NO llueva? (Decimal con un decimal).", skill: "est", difficulty: 6, answer: ["0.4"], fail_message: "Falla la probabilidad complementaria." },
    { text: "En una clase de 20, 15 son ni√±as. ¬øCu√°l es el porcentaje de ni√±os? (Escriba solo el n√∫mero entero: Ej: 25).", skill: "est", difficulty: 7, answer: ["25"], fail_message: "El c√°lculo de porcentaje es incorrecto." },
    { text: "¬øCu√°l es la Mediana de 1, 2, 3, 4? (Decimal con un decimal).", skill: "est", difficulty: 8, answer: ["2.5"], fail_message: "La Mediana en datos pares es incorrecta." },
    { text: "¬øCu√°l es el valor m√°s grande en el conjunto de datos 7, 12, 5, 12, 10? Escriba solo el n√∫mero entero.", skill: "est", difficulty: 6, answer: ["12"], fail_message: "El m√°ximo del conjunto es incorrecto." }
];

let player = {
    avatar: null,
    name: "N/A",
    stats: { alg: 0, geo: 0, est: 0 },
    lives: 3,
    kp: 0,
    skill_kp: { alg: 0, geo: 0, est: 0 } // Puntos por habilidad
};

let currentChallenge = null;

// Funci√≥n de limpieza: Elimina espacios, unidades comunes y convierte a min√∫sculas, reemplaza comas por puntos.
const cleanInput = (s) => s.toLowerCase().replace(/(\s|cm|m|\(|\))/g, '').replace(/,/g, '.');

// --- FUNCIONES DEL MENTOR (INICIO DEL C√ìDIGO) ---

function toggleChat() {
    const chatWindow = document.getElementById('mentor-chat-window');
    chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';

    if (chatWindow.style.display === 'flex') {
        const messagesDiv = document.getElementById('chat-messages');
        const inputField = document.getElementById('chat-input');
        inputField.focus();
        
        // Determinar el contexto del desaf√≠o actual para el mensaje de bienvenida
        const challengeText = currentChallenge ? `\n\nEl enigma actual es: "${currentChallenge.text}" (Habilidad: ${currentChallenge.skill.toUpperCase()}).` : '';
        
        // Mensaje de bienvenida adaptado
        const welcomeMessage = `Soy el Gu√≠a del Enigma. La jungla ha revelado el reto. Env√≠ame tu duda o tu planteamiento para recibir mi consejo. ${challengeText}`;
        messagesDiv.innerHTML = ''; // Limpiar mensajes
        appendMessage('gemini', welcomeMessage);
    }
}

function appendMessage(sender, text) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}-message`;

    // Manejo de formato simple (simulando Markdown)
    const formattedText = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');

    messageDiv.innerHTML = formattedText;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();

    if (!message) return;

    appendMessage('user', message);
    input.value = '';
    
    input.disabled = true;
    appendMessage('gemini', '‚öôÔ∏è El Or√°culo est√° consultando los patrones ancestrales...'); 
    const loadingMessage = document.querySelector('.gemini-message:last-child');

    const challengeContext = currentChallenge ? 
        `\n\nContexto del Reto: ${currentChallenge.text} (Habilidad: ${currentChallenge.skill})` : 
        "\n\nContexto: El jugador no ha iniciado un reto o est√° en el men√∫ principal.";

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${MENTOR_API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [
                    { role: "user", parts: [{ text: SYSTEM_INSTRUCTION_JUMANJI + challengeContext + "\n\nConsulta del jugador: " + message }] } 
                ],
                generationConfig: {
                    temperature: 0.7 
                }
            })
        });

        const data = await response.json();
        
        let responseText = '‚ùå Error: La jungla no permite la conexi√≥n. (Puede ser un bloqueo de CORS).';
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
             responseText = data.candidates[0].content.parts[0].text;
        } else if (data.error) {
            responseText = `‚ùå Error: La niebla densa bloquea la se√±al. C√≥digo: ${data.error.code}.`;
        }

        loadingMessage.remove(); 
        appendMessage('gemini', responseText);

    } catch (error) {
        console.error('Error al enviar mensaje a Gemini:', error);
        loadingMessage.remove(); 
        appendMessage('gemini', '‚ö†Ô∏è Fallo de conexi√≥n. Revisa si est√°s en un servidor local o si hay problemas de red.');
    } finally {
        input.disabled = false;
        document.getElementById('chat-input').focus();
    }
}


// --- FUNCIONES DE JUEGO PRINCIPAL ---

function rollDiceAndDrawCard() {
    if (player.lives <= 0) {
        displayCard("EXPEDICI√ìN FALLIDA", `¬°FIN DEL JUEGO! Has perdido todo tu Enfoque. Tu puntuaci√≥n final es: **${player.kp} Puntos de Conocimiento (KP)**.`, 'failure');
        document.getElementById('roll-dice').disabled = true;
        return;
    }
    
    if (!currentChallenge) {
        // Selecciona un nuevo reto (sin repetir, idealmente, pero la l√≥gica actual permite repetici√≥n)
        currentChallenge = CHALLENGES[Math.floor(Math.random() * CHALLENGES.length)];
        renderChallenge();
        return;
    }

    // 1. Obtener soluci√≥n del estudiante y limpiar
    const studentSolution = document.getElementById('student-solution').value.trim();
    if (studentSolution === "") {
        alert("¬°Alto! Debes escribir tu soluci√≥n matem√°tica antes de verificarla con los dados.");
        return;
    }
    
    // 2. Verificaci√≥n de exactitud
    const studentCleaned = cleanInput(studentSolution);
    const cleanExpected = currentChallenge.answer.map(cleanInput);
    const isSolutionExact = cleanExpected.includes(studentCleaned);
    
    // 3. Tirar el dado (D6)
    const d6Roll = Math.floor(Math.random() * 6) + 1;

    // 4. Obtener habilidad requerida y su valor
    const skillName = currentChallenge.skill;
    const skillValue = player.stats[skillName];
    const skillText = skillName === 'alg' ? '√Ålgebra' : skillName === 'geo' ? 'Geometr√≠a' : 'Estad√≠stica';

    // 5. Calcular el Resultado
    const totalScore = d6Roll + skillValue;
    const success = isSolutionExact && totalScore >= currentChallenge.difficulty;
    
    let resultMessage;
    let resultExplanation = "";

    if (success) {
        // Aumenta el puntaje total y por habilidad
        player.kp++; 
        player.skill_kp[skillName]++; 
        updateKP();
        updateScoreTable();
        resultExplanation = `El dado (${d6Roll}) + tu habilidad en ${skillText} (${skillValue}) supera la dificultad.`;
        resultMessage = `<div class="result success">‚úÖ ¬°C√ìDIGO DESCIFRADO! Superaste el reto de ${skillText}. **GANAS +1 KP (Total: ${player.kp})**</div>`;
    } else {
        // Solo pierdes vida, no se resta KP
        player.lives--;
        updateLives();
        
        let reason = "";
        if (!isSolutionExact) {
            reason = `Tu planteamiento matem√°tico fue **INCORRECTO** (Esperado: ${currentChallenge.answer.join(" o ")}).`;
        } else {
            reason = `Tu dominio de ${skillText} (${totalScore} total) no fue suficiente contra la Dificultad del Enigma (${currentChallenge.difficulty}).`;
        }

        if (player.lives <= 0) {
            resultMessage = `<div class="result failure">‚ùå ¬°ERROR FATAL! ${currentChallenge.fail_message}. ${reason} HAS PERDIDO TU √öLTIMO ENFOQUE. **Puntuaci√≥n Final: ${player.kp} KP.**</div>`;
        } else {
            resultMessage = `<div class="result failure">‚ùå ¬°ERROR! ${currentChallenge.fail_message}. ${reason} Puntos de Enfoque restantes: ${player.lives}.</div>`;
        }
    }

    // 6. Mostrar el Resultado y preparar el siguiente turno
    const cardContent = `
        <p id="problem-statement">Problema Resuelto: ${currentChallenge.text}</p>
        <p style="text-align:center; font-weight:700;">Tu Respuesta: <span style="color:var(--danger)">${studentSolution}</span></p>
        <p style="text-align:center; font-weight:700;">Respuesta Esperada: <span style="color:var(--success)">${currentChallenge.answer.join(" o ")}</span></p>
        <hr style="border-top:1px dashed var(--muted)">
        <p class="roll-info">Habilidad Requerida: ${skillText} (${skillValue})</p>
        <p class="roll-info">Tirada del Dado (D6): ${d6Roll}</p>
        <p class="roll-info">Puntuaci√≥n de √âxito: ${totalScore} (Dificultad: ${currentChallenge.difficulty})</p>
        <p class="roll-info">${resultExplanation}</p>
        ${resultMessage}
    `;
    displayCard("Resultado del Enigma", cardContent, success ? 'success' : 'failure');

    if (player.lives > 0) {
         document.getElementById('roll-dice').innerText = "LANZAR LOS DADOS (NUEVO RETO)";
    }
    
    currentChallenge = null;
    document.getElementById('roll-dice').removeEventListener('click', verifySolution);
    document.getElementById('roll-dice').addEventListener('click', rollDiceAndDrawCard);
    
    if (player.lives <= 0) {
        document.getElementById('roll-dice').disabled = true;
    }
}

function renderChallenge() {
    const skillText = currentChallenge.skill === 'alg' ? '√Ålgebra' : currentChallenge.skill === 'geo' ? 'Geometr√≠a' : 'Estad√≠stica';
    const cardContent = `
        <h3>RETO DE ${skillText.toUpperCase()} - DIFICULTAD: ${currentChallenge.difficulty}</h3>
        <p id="problem-statement">${currentChallenge.text}</p>
        <p style="color:var(--text-dark); margin-top:15px;">Paso 1: Resuelve el problema en tu cuaderno.</p>
        <label for="student-solution">Paso 2: Escribe aqu√≠ la respuesta final (¬°respeta el formato!):</label>
        <input id="student-solution" type="text" placeholder="Ej: 15 o 3/10" />
        <p style="color:var(--text-dark); margin-top:15px;">Paso 3: ¬°Lanza los dados para verificar tu dominio del tema!</p>
    `;
    displayCard("Carta de Desaf√≠o de 9¬∞ Grado", cardContent, 'accent-gold');
    document.getElementById('roll-dice').innerText = "VERIFICAR SOLUCI√ìN CON DADOS";
    
    document.getElementById('roll-dice').removeEventListener('click', rollDiceAndDrawCard);
    document.getElementById('roll-dice').addEventListener('click', verifySolution);
}

function verifySolution() {
    rollDiceAndDrawCard();
}


// --- FUNCIONES DE INTERFAZ DE USUARIO ---

function updateLives() {
    document.getElementById('stat-lives').innerText = player.lives;
    document.getElementById('stat-lives').style.color = player.lives > 1 ? 'var(--success)' : 'var(--danger)';
}

function updateKP() {
    document.getElementById('stat-kp').innerText = player.kp;
}

function updateScoreTable() {
    document.getElementById('kp-alg').innerText = player.skill_kp.alg;
    document.getElementById('kp-geo').innerText = player.skill_kp.geo;
    document.getElementById('kp-est').innerText = player.skill_kp.est;
}

function updateCharacterSheet() {
    document.getElementById('char-name').innerText = player.name;
    document.getElementById('stat-alg').innerText = player.stats.alg;
    document.getElementById('stat-geo').innerText = player.stats.geo;
    document.getElementById('stat-est').innerText = player.stats.est;
    updateLives();
    updateKP(); 
    updateScoreTable(); 
}

function displayCard(title, content, resultType) {
    const cardDisplay = document.getElementById('card-display');
    cardDisplay.innerHTML = `<h3>${title}</h3><div style="font-family: 'Inter', sans-serif;">${content}</div>`;
    cardDisplay.style.borderColor = resultType === 'success' ? 'var(--success)' : resultType === 'failure' ? 'var(--danger)' : 'var(--accent-gold)';
}

// --- MANEJO DE EVENTOS ---

document.getElementById('avatar-select').addEventListener('change', (e) => {
    const selectedValue = e.target.value;
    const descEl = document.getElementById('avatar-desc');
    if (selectedValue && AVATARS[selectedValue]) {
        descEl.innerText = AVATARS[selectedValue].desc;
        descEl.style.color = 'var(--text-dark)';
    } else {
        descEl.innerText = 'Selecciona un avatar para ver sus fortalezas.';
        descEl.style.color = 'var(--muted)';
    }
});


document.getElementById('confirm-avatar').addEventListener('click', () => {
    const selectedValue = document.getElementById('avatar-select').value;
    if (!selectedValue) {
        alert("Por favor, selecciona un Especialista para iniciar la Expedici√≥n.");
        return;
    }

    const avatarData = AVATARS[selectedValue];

    // Reiniciar y configurar el jugador
    player.avatar = selectedValue;
    player.name = avatarData.name;
    player.stats = { ...avatarData.stats };
    player.lives = 3; 
    player.kp = 0; 
    player.skill_kp = { alg: 0, geo: 0, est: 0 }; // Reiniciar KP por habilidad

    // Actualizar la interfaz y mostrar el tablero
    updateCharacterSheet();
    document.getElementById('char-selection').style.display = 'none';
    document.getElementById('game-board').style.display = 'grid';
    document.getElementById('roll-dice').disabled = false;
    document.getElementById('roll-dice').innerText = "LANZAR LOS DADOS (NUEVO RETO)";
    
    displayCard("¬°Bienvenido al Enigma de 9¬∞!", `Eres ${player.name}. Tu misi√≥n es resolver 30 c√≥digos matem√°ticos. Tienes 3 Puntos de Enfoque. **Presiona el bot√≥n** para recibir el primer desaf√≠o.`, 'accent-gold');
    
    document.getElementById('roll-dice').removeEventListener('click', verifySolution);
    document.getElementById('roll-dice').addEventListener('click', rollDiceAndDrawCard);
});

document.getElementById('roll-dice').addEventListener('click', rollDiceAndDrawCard);
document.getElementById('roll-dice').disabled = true; 

document.getElementById('mentor-send-btn').addEventListener('click', () => {
    const inputEl = document.getElementById('mentor-input');
    const query = inputEl.value;
    if (query && currentChallenge) {
        sendMessage(query + ` (Reto: ${currentChallenge.text})`);
        inputEl.value = '';
    } else if (query && !currentChallenge) {
        sendMessage(query + " (Reto no iniciado)");
        inputEl.value = '';
    } else {
        alert("Debes escribir una pregunta y lanzar el dado para ver un reto.");
    }
});

// Inicializar el chat modal al inicio
document.getElementById('mentor-chat-window').style.display = 'none';
</script>
</body>

</html>
